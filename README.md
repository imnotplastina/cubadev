# Тестовые вопросы

## 1
В БД mysql  есть одна единственная таблица «abc» с полями: id (int), name (varchar), cnt (int). В таблице содержится порядка 10 млн записей. Что нужно сделать, чтобы быстро работали следующие запросы (3 разных случая)? Все остальные факторы кроме скорости чтения не критичны.
   - ```SELECT * FROM abc WHERE name = 'xxx' AND cnt = yyy```
   - ```SELECT * FROM abc WHERE cnt = xxx AND name LIKE 'yyy%'```
   - ```SELECT * FROM abc ORDER BY cnt ASC```
   
**Ответ**:
- В первом запросе можно использовать **hash map** индекс, поскольку нет поиска по диапозону, к тому же сложность поиска по хеш мапе константная (в то время как у сбалансированного дерева сложность логарифмическая)
- Во втором запросе составной btree индекс ```(cnt, name)```
- В третьем запросе обычный btree индекс.

## 2
У вас есть задача обработки большого объема данных в PHP (например, парсинг CSV-файлов объемом в несколько гигабайт). Как вы будете обрабатывать этот файл, чтобы избежать превышения лимита памяти, и какие функции PHP и подходы для этого, eltnt использовать?

**Ответ**: Для итерации огромных коллекций можно применить **генераторы** которые появились в 5й версии PHP. Класс Generator имплементирующий интерфейс Iterator позволяет при итерации "забывать" предыдущее состояние, то есть освобождать память, для этого используется ```yield```

Если мы говорим про условный MySQL или Postgres, то можно выгружать данные чанками, используя курсорную пагинацию.

Если про CSV, то существует функция ```fgetcsv()``` которая читает файл построчно.

## 3
Есть код и запрос к БД, чтобы вы в нем изменили? Почему?

```$DB->query("SELECT * FROM abc WHERE id=" . $_GET['id']);```

**Ответ**: Здесь имеется явная уязвимость sql инъекций, поскольку запрос не подготовлен, в PDO для этого есть метод `prepare()`

Но лучше всего конечно использовать ORM и не париться :)

## 4
В БД есть таблица заказов (orders) с полями:
- date - дата оформления заказа
- customer_name - имя клиента
- order_price - сумма заказа


Напишите sql запросы для выборки:
1. Запрос, который покажет сколько денег принес каждый отдельно взятый покупатель с группировкой по месяцам.
2. Запрос, который выведет  имена клиентов, у которых суммарные покупки за весь период превысили 10 тыс. руб. и одновременно никогда не было заказов менее 500 руб.

**Ответ:** 
1. SELECT customer_name, DATE_FORMAT(date, '%Y-%m') AS month,
   SUM(order_price) AS total_spent FROM orders GROUP BY
   customer_name, month ORDER BY customer_name, month;

2. SELECT customer_name FROM
   orders GROUP BY customer_name HAVING SUM(order_price) > 10000 AND MIN(order_price) >= 500;


## 5
Есть две javascript-функции:

```function f(a,b) { return a+b }```
и ```var f = function(a,b) { return a+b }```

Есть ли между ними разница? Если есть то какая?

**Ответ**: В первом случае именованная функция поднимается в в верхнюю область видимости, то есть мы можем вызывать её даже до объявления.

Во втором случае анонимнаую функцию можно вызвать только после объявления, иначе получим ошибку.

## 6
Чем принципиально отличаются между собой условия LEFT JOIN и INNER JOIN в sql? Какой вариант JOIN может дать потенциально больше результатов (строк) и почему?

**Ответ:** INNER JOIN возвращает только те строки, которые имеют соответствия в обеих таблицах

LEFT JOIN возвращает все строки из левой таблицы, а также соответствующие строки из правой таблицы.

Потенциально в LEFT JOIN будет больше строк.

## 7
Вам нужно реализовать консольный php-скрипт на сервере под Unix, который бы выводил каждые 15 секунд фразу «Hello». После вывода «Hello» скрипт всегда завершает работу. Напишите этот скрипт и пошагово расскажите, что нужно сделать, чтобы выполнялись исходные условия. 

**Ответ:** 
1. Создам сам php файл с выводом текста, ```<?php echo "Hello";```
2. С помощью chmod выдам права для запуска из терминала, ```chmod +x script.php```
3. Создам bash файл с бесконечным циклом

```
#!/bin/bash

while true; do
    php script.php
    sleep 15
done
```

4. Затем запускаю bash скрипт в фоновом режиме ```./bash.sh &```

P.S Так же возможен вариант с кроном.

## 8

Напишите на php функцию для распределения рублевой скидки по купону на все товары в корзине пропорционально стоимости товара. На входе в функцию передаются два параметра: размер скидки в рублях (!) и массив из цен товаров, на выходе тот же массив цен, но уже с учетом скидки: distribute_discount(int discount, array prices) → return array $prices;

**Ответ:** Я знаю 2 способа работы с деньгами (я буду использовать первый потому что ранее уже сталкивался):
1. Через тип decimal
2. Работать с копейками, то есть 1 рубль в базе храниться будет как 100

Буду использовать библиотеку BCMath которая предназначена для работы с произвольной точностью чисел.

Код находится в файле ```discount.php```





